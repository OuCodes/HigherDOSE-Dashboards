name: Auto-Refresh BFCM Dashboard

on:
  schedule:
    # Run at 8am, 2pm, 8pm EST (13:00, 19:00, 01:00 UTC)
    - cron: '0 13,19,1 * * *'
  
  # Allow manual trigger from GitHub UI
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install requests pandas python-dateutil
      
      - name: ðŸ”„ Fetch fresh Klaviyo data
        env:
          KLAVIYO_API_KEY: ${{ secrets.KLAVIYO_API_KEY }}
        run: |
          echo "ðŸ“§ Fetching 2024 email campaigns..."
          python scripts/klaviyo_quick_export.py --start 2024-11-01 --end 2024-12-31 --output data/mail/klaviyo_campaigns_bfcm_2024.csv
          
          echo "ðŸ“§ Fetching 2025 email campaigns..."
          python scripts/klaviyo_quick_export.py --start 2025-11-01 --end 2025-12-31 --output data/mail/klaviyo_campaigns_bfcm_2025_planned.csv
          
          echo "âœ… Email data refresh complete: $(date)"
      
      - name: ðŸ“ Commit updated data
        run: |
          git config user.name "Dashboard Bot"
          git config user.email "dashboard-bot@higherdose.com"
          
          # Add updated files
          git add data/mail/*.csv
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "ðŸ“­ No changes to commit"
          else
            echo "ðŸ“¬ Changes detected, committing..."
            git commit -m "ðŸ”„ Auto-update dashboard data - $(date +'%Y-%m-%d %H:%M UTC')"
            git push
            echo "âœ… Data pushed successfully"
          fi
      
      - name: ðŸ“Š Update summary
        run: |
          echo "### âœ… Dashboard Data Refresh Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Data updated and pushed to repository" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Streamlit will automatically rebuild in 2-3 minutes." >> $GITHUB_STEP_SUMMARY

